# Version 0.6.0 Architecture

## Overview

Version 0.6.0 introduces advanced features for better control, monitoring, and user management:
- âœ… **Vacation Mode** (RELEASED)
- ðŸŒ **Internationalization (i18n)** (RELEASED)
- Heating Efficiency Reports (PLANNED)
- Multi-User Presence Tracking (PLANNED)
- Historical Comparisons (PLANNED)
- Import/Export Configuration (PLANNED)

## Released Features

### 1. Vacation Mode âœ…

**Status**: Released in v0.6.0

**Purpose**: One-click mode to set all areas to Away preset for extended periods.

**Data Structure**:
```python
vacation_mode = {
    "enabled": bool,
    "start_date": str (ISO format),
    "end_date": str (ISO format),
    "preset_mode": str (default: "away"),
    "frost_protection_override": bool,
    "min_temperature": float,
    "auto_disable": bool  # Auto-disable when someone arrives home
}
```

**Storage**: `.storage/smart_heating/vacation_mode.json`

**Backend Components**:
- `vacation_manager.py` - Manages vacation mode state and area overrides
- API endpoint: `/api/smart_heating/vacation_mode` (GET, POST, DELETE)
- Service: `smart_heating.enable_vacation_mode`, `smart_heating.disable_vacation_mode`

**Frontend Components**:
- Global settings page: Vacation Mode section with date picker
- Banner notification when vacation mode is active
- Quick toggle in main dashboard

**Logic**:
- When enabled: Override all area preset modes to "away" (or configured preset)
- Respect frost protection minimum temperature
- Can auto-disable when any configured person entity comes home
- Schedules are suspended during vacation mode
- Manual override still works per area

---

### 2. Internationalization (i18n) âœ…

**Status**: Released in v0.6.0

**Purpose**: Multi-language support for global deployment and improved accessibility.

**Supported Languages**:
- ðŸ‡¬ðŸ‡§ English (default)
- ðŸ‡³ðŸ‡± Dutch (Nederlands)

**Implementation**:

**Frontend Framework**:
- `i18next` - Core internationalization framework
- `react-i18next` - React bindings for i18next
- `i18next-browser-languagedetector` - Automatic language detection

**Translation Structure**:
```typescript
// src/locales/en/translation.json
{
  "common": { "loading": "Loading...", "save": "Save", ... },
  "header": { "title": "Smart Heating", "connected": "Connected", ... },
  "dashboard": { "zones": "Zones", "hiddenCount": "{{count}} hidden", ... },
  "area": { "targetTemperature": "Target Temperature", ... },
  "vacation": { "title": "Vacation Mode", ... },
  "presets": { "away": "Away", "eco": "Eco", ... },
  // ... 200+ translation keys organized by feature domain
}
```

**Language Detection**:
1. Custom Home Assistant detector:
   - Reads `localStorage.selectedLanguage` from HA settings
   - Detects HA's configured language automatically
2. Browser language detector (fallback)
3. HTML tag language (final fallback)
4. Default: English

**Storage**: Translation files in `smart_heating/frontend/src/locales/{language}/translation.json`

**Backend Components**:
- No backend changes required
- All translations are client-side
- Language preference stored in browser localStorage

**Frontend Components**:
- `i18n.ts` - i18n configuration and initialization
- `Header.tsx` - Language switcher with dropdown menu (ðŸŒ icon)
- All components updated with `useTranslation()` hook
- Dynamic translation of:
  - Navigation and headers
  - Form labels and placeholders
  - Error messages and alerts
  - Button labels and tooltips
  - Chart labels and legends
  - Table headers and content

**Usage in Components**:
```typescript
import { useTranslation } from 'react-i18next'

const MyComponent = () => {
  const { t, i18n } = useTranslation()
  
  return (
    <div>
      <h1>{t('header.title')}</h1>
      <p>{t('dashboard.hiddenCount', { count: 5 })}</p>
      <button onClick={() => i18n.changeLanguage('nl')}>
        Nederlands
      </button>
    </div>
  )
}
```

**Documentation**:
- English: `README.md`, `CHANGELOG.md` (root directory)
- Dutch: `README.nl.md`, `CHANGELOG.nl.md` (root directory)
- Language-specific docs: `docs/en/`, `docs/nl/` directories

**Adding New Languages**:
1. Create translation file: `src/locales/{lang}/translation.json`
2. Copy English translations and translate all keys
3. Add language option to Header language switcher
4. Update i18n configuration with new language
5. Create documentation in `docs/{lang}/` directory

---

## Planned Features

### 3. Heating Efficiency Reports

**Purpose**: Show which areas are heating efficiently vs struggling.

**Metrics Tracked**:
```python
efficiency_data = {
    "area_id": str,
    "period": str,  # "day", "week", "month"
    "heating_time_percentage": float,  # % of time heating was on
    "average_temperature_delta": float,  # avg(target - current)
    "heating_cycles": int,  # number of on/off cycles
    "energy_score": float,  # calculated efficiency score (0-100)
    "temperature_stability": float,  # std dev of temperature
    "outdoor_correlation": float,  # how much outdoor temp affects it
}
```

**Calculation**:
- Energy Score = 100 - (heating_time_percentage Ã— temperature_delta_factor Ã— cycle_penalty)
- Higher score = more efficient (reaches target quickly, maintains well)
- Lower score = less efficient (struggles to heat, frequent cycling)

**Storage**: Statistics API (Home Assistant long-term storage)

**Backend Components**:
- `efficiency_calculator.py` - Calculates metrics from history data
- API endpoint: `/api/smart_heating/efficiency_report?period=week&area_id=all`
- Scheduled calculation: Daily at 2 AM

**Frontend Components**:
- New "Efficiency" tab in main dashboard
- Bar chart showing efficiency scores per area
- Detailed metrics table with filtering
- Recommendations based on low scores

---

### 4. Multi-User Presence Tracking

**Status**: Planned for future release

**Purpose**: Track which family members are home and adjust temperatures per person.

**Data Structure**:
```python
user_profile = {
    "user_id": str,  # Home Assistant person entity ID
    "name": str,
    "preset_preferences": {
        "home": float,  # preferred temp when this user is home alone
        "away": float,
        "sleep": float,
        # ... other presets
    },
    "priority": int,  # 1-10, higher priority user's preferences take precedence
    "areas": [str],  # which areas this user cares about (empty = all)
}

presence_state = {
    "users_home": [str],  # list of user_ids currently home
    "active_user": str,  # highest priority user currently home
    "combined_mode": str,  # "single", "multiple", "none"
}
```

**Storage**: `.storage/smart_heating/user_profiles.json`

**Logic**:
- When multiple users home: Use highest priority user's preferences
- Or: Average temperatures from all users' preferences (configurable)
- When single user home: Use their preferences
- When no one home: Use global Away preset
- Override active when user manually adjusts (respects user intent)

**Backend Components**:
- `user_manager.py` - Manages user profiles and presence state
- Integrates with Home Assistant person entities
- API endpoints: `/api/smart_heating/users`, `/api/smart_heating/users/{user_id}`

**Frontend Components**:
- User Profiles page in settings
- Live presence indicator showing who's home
---

### 4. Historical Comparisons

**Status**: Planned for future release

### 4. Historical Comparisons

**Purpose**: Compare current heating performance to previous periods.

**Comparison Types**:
- This week vs last week
- This month vs last month
- This month vs same month last year
- Custom date range A vs date range B

**Metrics Compared**:
```python
comparison_data = {
    "period_a": {
        "start": str,
        "end": str,
        "avg_temperature": float,
        "avg_outdoor_temp": float,
        "total_heating_hours": float,
        "avg_efficiency_score": float,
    },
    "period_b": { ... },
    "delta": {
        "temperature_change": float,
        "heating_hours_change": float,
        "efficiency_change": float,
        "estimated_energy_savings": float,  # percentage
    }
}
```

**Backend Components**:
- `comparison_engine.py` - Fetches and compares historical data
- API endpoint: `/api/smart_heating/compare?period_a=2025-W48&period_b=2025-W47`
- Uses Home Assistant Statistics API for historical data

**Frontend Components**:
- "Insights" or "Analytics" page
- Date range selectors with preset options
- Side-by-side comparison charts
---

### 5. Import/Export Configuration

**Status**: Planned for future release

### 5. Import/Export Configuration

**Purpose**: Backup and restore all Smart Heating settings.

**Export Data Structure**:
```python
export_data = {
    "version": "0.6.0",
    "export_date": str (ISO format),
    "areas": {...},  # Full area configurations
    "schedules": {...},  # All schedules
    "global_settings": {
        "frost_protection": {...},
        "global_presets": {...},
        "global_presence": {...},
    },
    "user_profiles": {...},  # User preferences
    "vacation_mode": {...},  # Vacation settings
    # Excludes: history data, efficiency calculations, logs
}
```

**File Format**: JSON

**Backend Components**:
- API endpoint: `/api/smart_heating/export` (GET - returns JSON download)
- API endpoint: `/api/smart_heating/import` (POST - accepts JSON upload)
- Validation and version compatibility checking
- Backup creation before import

**Frontend Components**:
- Settings page: Export/Import section
- Download button generates `smart_heating_backup_YYYY-MM-DD.json`
- Upload button with drag-and-drop support
- Preview import changes before applying
- Confirmation dialog showing what will change

**Safety Features**:
- Automatic backup before import
- Validation of imported JSON structure
- Version compatibility warnings
- Option to selectively import (e.g., just schedules, not global settings)

---

## Database Schema Changes

### New Tables/Collections

**User Profiles** (`.storage/smart_heating/user_profiles.json`):
```json
{
  "users": {
    "person.john": {
      "user_id": "person.john",
      "name": "John",
      "preset_preferences": {
        "home": 21.0,
        "away": 16.0,
        "sleep": 18.0
      },
      "priority": 10,
      "areas": []
    }
  }
}
```

**Vacation Mode** (`.storage/smart_heating/vacation_mode.json`):
```json
{
  "enabled": false,
  "start_date": null,
  "end_date": null,
  "preset_mode": "away",
  "frost_protection_override": true,
  "min_temperature": 10.0,
  "auto_disable": true
}
```

**Efficiency Cache** (Statistics API, entity: `sensor.smart_heating_efficiency_{area_id}`):
- Stored as sensor attributes
- Updated daily
- Retained by HA's recorder component

---

## API Endpoints

### Vacation Mode
- `GET /api/smart_heating/vacation_mode` - Get current vacation mode state
- `POST /api/smart_heating/vacation_mode` - Enable vacation mode
- `DELETE /api/smart_heating/vacation_mode` - Disable vacation mode

### User Profiles
- `GET /api/smart_heating/users` - List all user profiles
- `POST /api/smart_heating/users` - Create user profile
- `GET /api/smart_heating/users/{user_id}` - Get user profile
- `PUT /api/smart_heating/users/{user_id}` - Update user profile
- `DELETE /api/smart_heating/users/{user_id}` - Delete user profile

### Efficiency
- `GET /api/smart_heating/efficiency?period=week&area_id=all` - Get efficiency report

### Comparisons
- `GET /api/smart_heating/compare?type=week&offset=1` - Compare this week to last week
- `GET /api/smart_heating/compare?start_a=2025-11-01&end_a=2025-11-30&start_b=2024-11-01&end_b=2024-11-30` - Custom comparison

### Import/Export
- `GET /api/smart_heating/export` - Download configuration JSON
- `POST /api/smart_heating/import` - Upload and apply configuration JSON
- `POST /api/smart_heating/import/preview` - Preview import changes without applying

---

## WebSocket Events

New event types:
- `vacation_mode_changed` - Vacation mode enabled/disabled
- `user_presence_changed` - User came home or left
- `efficiency_updated` - Daily efficiency scores calculated
- `import_completed` - Configuration import finished

---

## Service Calls

New services:
```yaml
smart_heating.enable_vacation_mode:
  description: Enable vacation mode
  fields:
    start_date:
      description: Start date (ISO format)
    end_date:
      description: End date (ISO format)
    preset_mode:
      description: Preset to use (default: away)

smart_heating.disable_vacation_mode:
  description: Disable vacation mode

smart_heating.export_config:
  description: Export configuration to file
  fields:
    filename:
      description: Output filename (optional)

smart_heating.import_config:
  description: Import configuration from file
  fields:
    data:
      description: JSON configuration data
    backup:
      description: Create backup before import (default: true)
```

---

## UI Components Structure

### New Pages/Sections

**Global Settings Enhancements**:
- Vacation Mode panel
- User Profiles management

**New Analytics Page**:
- Efficiency Reports tab
- Historical Comparisons tab
- Charts and visualizations

**Enhanced Settings**:
- Import/Export section
- Backup management

### Component Hierarchy

```
App
â”œâ”€â”€ Dashboard (existing)
â”œâ”€â”€ Analytics (NEW)
â”‚   â”œâ”€â”€ EfficiencyReports
â”‚   â”‚   â”œâ”€â”€ EfficiencyChart
â”‚   â”‚   â”œâ”€â”€ EfficiencyTable
â”‚   â”‚   â””â”€â”€ RecommendationsList
â”‚   â”œâ”€â”€ HistoricalComparisons
â”‚   â”‚   â”œâ”€â”€ ComparisonPeriodSelector
â”‚   â”‚   â”œâ”€â”€ ComparisonChart
â”‚   â”‚   â””â”€â”€ DeltaIndicators
â”œâ”€â”€ Settings (enhanced)
â”‚   â”œâ”€â”€ VacationMode
â”‚   â”‚   â”œâ”€â”€ DateRangePicker
â”‚   â”‚   â””â”€â”€ VacationSettings
â”‚   â”œâ”€â”€ UserProfiles
â”‚   â”‚   â”œâ”€â”€ UserProfileList
â”‚   â”‚   â”œâ”€â”€ UserProfileEditor
â”‚   â”‚   â””â”€â”€ PresenceIndicator
â”‚   â”œâ”€â”€ ImportExport
â”‚   â”‚   â”œâ”€â”€ ExportButton
â”‚   â”‚   â”œâ”€â”€ ImportUploader
â”‚   â”‚   â””â”€â”€ BackupList
â””â”€â”€ AreaDetail (existing)
```

---

## Implementation Order

1. **Vacation Mode** (Simplest, high value)
   - Backend: vacation_manager.py
   - API endpoints
   - Frontend UI
   - E2E tests

2. **Import/Export** (Foundation for backup/restore)
   - Export endpoint
   - Import endpoint with validation
   - Frontend UI
   - E2E tests

3. **Multi-User Presence** (Builds on existing presence)
   - User manager backend
   - User profiles storage
   - API endpoints
   - Frontend UI
   - E2E tests

4. **Efficiency Reports** (Requires history data)
   - Efficiency calculator
   - Statistics integration
   - API endpoint
   - Frontend charts
   - E2E tests

5. **Historical Comparisons** (Most complex)
   - Comparison engine
   - API endpoint
   - Frontend analytics page
   - E2E tests

---

## Testing Strategy

### E2E Test Coverage

**Vacation Mode**:
- Enable vacation mode with date range
- Verify all areas switch to away preset
- Disable vacation mode
- Auto-disable when person arrives home

**User Profiles**:
- Create user profile with preferences
- Update user preferences
- Delete user profile
- Verify temperature changes when user presence changes

**Efficiency Reports**:
- View efficiency scores for all areas
- Filter by time period
- Verify score calculations
- Check recommendations display

**Historical Comparisons**:
- Select comparison periods
- View comparison charts
- Verify delta calculations
- Export comparison data

**Import/Export**:
- Export configuration
- Verify JSON structure
- Import configuration
- Verify settings restored correctly
- Import with selective options

---

## Performance Considerations

- **Efficiency Calculations**: Run daily at 2 AM to avoid impacting system during day
- **Historical Queries**: Cache comparison results for 1 hour
- **User Presence**: Debounce presence changes (30 second delay to avoid rapid switching)
- **Export**: Limit to 1 export per minute to prevent abuse
- **Import**: Validate before applying, create backup automatically

---

## Migration Path

From v0.5.x to v0.6.0:
1. No database migrations needed (new features only)
2. Existing configurations remain unchanged
3. New features disabled by default
4. Users opt-in to new features via UI

---

## Security Considerations

- User profiles stored locally (no cloud sync)
- Export files may contain sensitive schedule data
- Import validation prevents malicious JSON injection
- Backup files stored in `.storage` (standard HA security)
- No external API calls for new features
